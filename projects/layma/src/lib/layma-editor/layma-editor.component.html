<div class="layma-editor">
  <!-- ── Sidebar: drawing tools ── -->
  <aside class="layma-sidebar" role="toolbar" aria-label="Drawing tools">
    <button
      type="button"
      class="layma-sideBtn"
      [class.isActive]="tool() === 'select'"
      (click)="setTool('select')"
      title="Select (V)"
    >
      <svg viewBox="0 0 20 20" fill="currentColor" class="layma-icon">
        <path d="M4 2l10 8-4.5 1.2L13 17l-2.5 1-3.5-5.8L3 15z" />
      </svg>
    </button>

    <button
      type="button"
      class="layma-sideBtn"
      [class.isActive]="tool() === 'text'"
      (click)="setTool('text')"
      title="Text (T)"
    >
      <svg viewBox="0 0 20 20" fill="currentColor" class="layma-icon">
        <path d="M4 4v3h1.5V5.5h4V15H7.5v1.5h5V15H10.5V5.5h4V7H16V4z" />
      </svg>
    </button>

    <button
      type="button"
      class="layma-sideBtn"
      [class.isActive]="tool() === 'rect'"
      (click)="setTool('rect')"
      title="Rectangle (R)"
    >
      <svg
        viewBox="0 0 20 20"
        fill="none"
        stroke="currentColor"
        stroke-width="1.5"
        class="layma-icon"
      >
        <rect x="3" y="4" width="14" height="12" rx="2" />
      </svg>
    </button>

    <button
      type="button"
      class="layma-sideBtn"
      [class.isActive]="tool() === 'line'"
      (click)="setTool('line')"
      title="Line (L)"
    >
      <svg
        viewBox="0 0 20 20"
        fill="none"
        stroke="currentColor"
        stroke-width="1.5"
        class="layma-icon"
      >
        <line x1="3" y1="17" x2="17" y2="3" />
      </svg>
    </button>

    <button
      type="button"
      class="layma-sideBtn"
      [class.isActive]="tool() === 'image'"
      (click)="setTool('image')"
      title="Image (I)"
    >
      <svg
        viewBox="0 0 20 20"
        fill="none"
        stroke="currentColor"
        stroke-width="1.5"
        class="layma-icon"
      >
        <rect x="3" y="4" width="14" height="12" rx="2" />
        <circle cx="7.5" cy="8" r="1.5" fill="currentColor" stroke="none" />
        <polyline points="3,14 7,10 10,13 13,9 17,14" fill="none" />
      </svg>
    </button>

    <button
      type="button"
      class="layma-sideBtn"
      [class.isActive]="tool() === 'table'"
      (click)="setTool('table')"
      title="Table (B)"
    >
      <svg
        viewBox="0 0 20 20"
        fill="none"
        stroke="currentColor"
        stroke-width="1.5"
        class="layma-icon"
      >
        <rect x="3" y="4" width="14" height="12" rx="1" />
        <line x1="3" y1="8" x2="17" y2="8" />
        <line x1="3" y1="12" x2="17" y2="12" />
        <line x1="9" y1="4" x2="9" y2="16" />
      </svg>
    </button>
  </aside>

  <!-- ── Header: actions ── -->
  <header class="layma-header">
    <span class="layma-headerTitle">Layma</span>
    <span
      class="layma-sectionChip"
      [class.isHeader]="activeSection() === 'header'"
      [class.isBody]="activeSection() === 'body'"
      [class.isFooter]="activeSection() === 'footer'"
    >
      Editing: {{ activeSection() }}
    </span>

    <div class="layma-headerActions">
      <button
        type="button"
        class="layma-headerBtn"
        [disabled]="hasInvalidTableBindings()"
        [title]="exportHtmlDisabledTitle()"
        (click)="requestExport()"
      >
        Export HTML
      </button>
      <button type="button" class="layma-headerBtn" (click)="triggerRdlPick()">Import RDL</button>
    </div>

    <input
      #fileInput
      type="file"
      accept="image/*"
      multiple
      class="layma-hidden"
      (change)="onImageFilePicked()"
    />
    <input
      #rdlInput
      type="file"
      accept=".rdl,application/xml,text/xml"
      class="layma-hidden"
      (change)="onRdlFilePicked()"
    />
  </header>

  <!-- ── Stage: canvas ── -->
  <div
    class="layma-stage"
    (pointerdown)="clearSelection()"
    (dragover)="onStageDragOver($event)"
    (drop)="onStageDrop($event)"
  >
    <div
      #page
      class="layma-page"
      [ngStyle]="pageStyle()"
      [style.--layma-grid-size]="gridSizeMm() + 'mm'"
      (pointerdown)="onPagePointerDown($event)"
    >
      <div
        class="layma-zone layma-zone--header"
        [class.isActive]="activeSection() === 'header'"
        [ngStyle]="headerZoneStyle()"
        (dblclick)="onZoneDblClick($event, 'header')"
      >
        <span class="layma-zoneLabel">Header</span>
      </div>
      <div
        class="layma-zone layma-zone--body"
        [class.isActive]="activeSection() === 'body'"
        [ngStyle]="bodyZoneStyle()"
        (dblclick)="onZoneDblClick($event, 'body')"
      >
        <span class="layma-zoneLabel">Body</span>
      </div>
      <div
        class="layma-zone layma-zone--footer"
        [class.isActive]="activeSection() === 'footer'"
        [ngStyle]="footerZoneStyle()"
        (dblclick)="onZoneDblClick($event, 'footer')"
      >
        <span class="layma-zoneLabel">Footer</span>
      </div>
      @for (el of elements(); track el.id; let idx = $index) {
      <div
        class="layma-elementHost"
        [class.isSelected]="isElementSelected(el.id)"
        [class.isInactiveSection]="el.section !== activeSection()"
        [ngClass]="elementClass(el)"
        [ngStyle]="elementStyle(el, idx)"
        (pointerdown)="onElementPointerDown($event, el.id)"
      >
        @switch (el.type) { @case ('text') {
        <div
          class="layma-text"
          [class.isEditing]="editingTextId() === el.id"
          [attr.contenteditable]="editingTextId() === el.id ? 'plaintext-only' : null"
          [ngStyle]="{
            fontFamily: el.fontFamily,
            fontWeight: el.fontWeight,
            fontSize: el.fontSizePt + 'pt',
            color: el.color,
            textAlign: el.align,
            padding: el.paddingMm + 'mm',
            '--layma-pad': el.paddingMm + 'mm'
          }"
          [textContent]="editingTextId() === el.id ? null : el.text"
          (dblclick)="onTextDblClick($event, el.id)"
          (blur)="onTextBlur($event, el.id)"
          (keydown)="onTextKeyDown($event)"
        ></div>
        } @case ('rect') {
        <div
          class="layma-rect"
          [ngStyle]="{
            background: el.fillColor,
            borderColor: el.borderColor,
            borderWidth: el.borderWidthMm + 'mm',
            borderStyle: 'solid',
            borderRadius: el.borderRadiusMm + 'mm'
          }"
        ></div>
        } @case ('line') {
        <div class="layma-line" [ngStyle]="{ background: el.color }"></div>
        } @case ('image') { @if (isImageBroken(el.id)) {
        <div class="layma-imagePlaceholder">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
            class="layma-imagePlaceholderIcon"
          >
            <rect x="3" y="3" width="18" height="18" rx="3" />
            <line x1="3" y1="3" x2="21" y2="21" />
          </svg>
        </div>
        } @else {
        <img
          class="layma-image"
          [src]="el.dataUri"
          [style.objectFit]="el.objectFit"
          [style.opacity]="el.opacity"
          alt=""
          draggable="false"
          (error)="onImageError(el.id)"
        />
        } } @case ('table') {
        <div class="layma-tablePreview">
          <table class="layma-tablePreviewInner" cellspacing="0" cellpadding="0">
            <colgroup>
              @for (c of el.columns; track $index) {
              <col [style.width]="c.widthMm + 'mm'" />
              }
            </colgroup>
            <thead>
              <tr>
                @for (c of tableCells(el, 'header'); track $index) {
                <th
                  class="layma-tablePreviewCell layma-tablePreviewCell--header"
                  [class.isEditing]="isEditingTableCell(el.id, 'header', $index)"
                  [attr.contenteditable]="
                    isEditingTableCell(el.id, 'header', $index) ? 'plaintext-only' : null
                  "
                  [ngStyle]="tablePreviewCellStyle(el, c, 'header', $index)"
                  [textContent]="isEditingTableCell(el.id, 'header', $index) ? null : c.text"
                  (dblclick)="onTableCellDblClick($event, el.id, 'header', $index)"
                  (blur)="onTableCellBlur($event, el.id, 'header', $index)"
                  (keydown)="onTableCellKeyDown($event)"
                ></th>
                }
              </tr>
            </thead>
            <tbody>
              <tr>
                @for (c of tableCells(el, 'rowTemplate'); track $index) {
                <td
                  class="layma-tablePreviewCell"
                  [class.isEditing]="isEditingTableCell(el.id, 'row', $index)"
                  [attr.contenteditable]="
                    isEditingTableCell(el.id, 'row', $index) ? 'plaintext-only' : null
                  "
                  [ngStyle]="tablePreviewCellStyle(el, c, 'rowTemplate', $index)"
                  [textContent]="isEditingTableCell(el.id, 'row', $index) ? null : c.text"
                  (dblclick)="onTableCellDblClick($event, el.id, 'row', $index)"
                  (blur)="onTableCellBlur($event, el.id, 'row', $index)"
                  (keydown)="onTableCellKeyDown($event)"
                ></td>
                }
              </tr>
            </tbody>
            <tfoot>
              <tr>
                @for (c of tableCells(el, 'footer'); track $index) {
                <td
                  class="layma-tablePreviewCell layma-tablePreviewCell--footer"
                  [class.isEditing]="isEditingTableCell(el.id, 'footer', $index)"
                  [attr.contenteditable]="
                    isEditingTableCell(el.id, 'footer', $index) ? 'plaintext-only' : null
                  "
                  [ngStyle]="tablePreviewCellStyle(el, c, 'footer', $index)"
                  [textContent]="isEditingTableCell(el.id, 'footer', $index) ? null : c.text"
                  (dblclick)="onTableCellDblClick($event, el.id, 'footer', $index)"
                  (blur)="onTableCellBlur($event, el.id, 'footer', $index)"
                  (keydown)="onTableCellKeyDown($event)"
                ></td>
                }
              </tr>
            </tfoot>
          </table>
        </div>
        } }
      </div>
      }

      <!-- Selection bounding box -->
      @if (selectionBoxStyle(); as s) {
      <div class="layma-selection" [ngStyle]="s" aria-hidden="true">
        <!-- Resize handles only for single selection -->
        @if (selectedElements().length === 1) {
        <div
          class="layma-handle layma-handle--nw"
          (pointerdown)="onResizeHandlePointerDown($event, 'nw')"
        ></div>
        <div
          class="layma-handle layma-handle--n"
          (pointerdown)="onResizeHandlePointerDown($event, 'n')"
        ></div>
        <div
          class="layma-handle layma-handle--ne"
          (pointerdown)="onResizeHandlePointerDown($event, 'ne')"
        ></div>
        <div
          class="layma-handle layma-handle--e"
          (pointerdown)="onResizeHandlePointerDown($event, 'e')"
        ></div>
        <div
          class="layma-handle layma-handle--se"
          (pointerdown)="onResizeHandlePointerDown($event, 'se')"
        ></div>
        <div
          class="layma-handle layma-handle--s"
          (pointerdown)="onResizeHandlePointerDown($event, 's')"
        ></div>
        <div
          class="layma-handle layma-handle--sw"
          (pointerdown)="onResizeHandlePointerDown($event, 'sw')"
        ></div>
        <div
          class="layma-handle layma-handle--w"
          (pointerdown)="onResizeHandlePointerDown($event, 'w')"
        ></div>
        }
      </div>
      }

      <!-- Marquee selection rectangle -->
      @if (marqueeStyle(); as m) {
      <div class="layma-marquee" [ngStyle]="m" aria-hidden="true"></div>
      }
    </div>

    <!-- ── Properties panel (sticky, right side) ── -->
    @if (selectedElement(); as sel) {
    <layma-props
      [element]="sel"
      [tableEntityBindings]="tableEntityBindings()"
      (pointerdown)="$event.stopPropagation()"
      (propChange)="onPropsChange($event)"
      (close)="clearSelection()"
      (deleteElement)="deleteSelected()"
      (reorder)="onPropsReorder($event)"
      (replaceImage)="replaceSelectedImage()"
      (imageFitChange)="setSelectedImageObjectFit($event)"
    />
    } @else if (selectedElements().length > 1) {
    <div class="layma-multiSelect" (pointerdown)="$event.stopPropagation()">
      <div class="layma-multiSelectHeader">
        <span class="layma-multiSelectCount">{{ selectedElements().length }} elements</span>
        <button type="button" class="layma-propsClose" (click)="clearSelection()">&times;</button>
      </div>
      <button type="button" class="layma-propsDeleteBtn" (click)="deleteSelected()">
        Delete all
      </button>
    </div>
    }
  </div>
</div>
